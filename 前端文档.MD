#   协同系统 API 文档

## 1. 基础说明 (Base Info)

本系统采用双后端架构，前端需根据业务类型请求不同的端口。

| **服务名称**  | **端口** | **职责描述**                                           |
| ------------- | -------- | ------------------------------------------------------ |
| **Java 后端** | `8080`   | 用户系统、文档列表管理、元数据存储 (MySQL)             |
| **Go 后端**   | `8081`   | 静态文件上传、WebSocket 实时协同、版本快照、Redis 存储 |

### 统一响应格式 (Result)

除非特殊说明，所有 **Java 接口** 均返回以下 JSON 结构：

JSON

```
{
  "code": 200,      // 200 表示成功，500 表示失败
  "msg": "OK",      // 提示信息
  "data": { ... }   // 具体业务数据
}
```

### 鉴权方式 (Authentication)

- **Token 机制**: JWT (Json Web Token)
- **传递方式**: HTTP Header
- **Key**: `Authorization`
- **Value**: `<Token字符串>` (无需 Bearer 前缀)

------

## 2. 用户系统 (Java: 8080)

### 2.1 用户注册

- **URL**: `http://localhost:8080/user/register`
- **Method**: `POST`
- **Content-Type**: `application/json`

**请求参数:**

JSON

```
{
  "username": "test001",
  "password": "123456",
  "nickname": "测试用户" // 可选
}
```

**响应示例:**

JSON

```
{
  "code": 200,
  "msg": "OK",
  "data": {
    "id": 10,
    "username": "test001",
    "role": "USER",
    "createTime": "..."
  }
}
```

### 2.2 用户登录

- **URL**: `http://localhost:8080/user/login`
- **Method**: `POST`
- **Content-Type**: `application/json`

**请求参数:**

JSON

```
{
  "username": "admin",
  "password": "123456"
}
```

**响应示例:**

JSON

```
{
  "code": 200,
  "msg": "OK",
  "data": "eyJhbGciOiJIUzI1NiJ9.eyJ..." // 直接返回 Token 字符串
}
```

> **注意**: 登录接口仅返回 Token 字符串。前端需要手动解析 JWT (Base64 Decode) 以获取 `userId` 和 `nickname`。

------

## 3. 文档管理 (Java: 8080)

### 3.1 获取文档列表

- **URL**: `http://localhost:8080/doc/list`
- **Method**: `GET`
- **Header**: `Authorization: <Token>`

**响应示例:**

JSON

```
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "title": "图片.png",
      "docType": 0,       // 0=静态文件, 1=协同文档
      "fileKey": "http://localhost:8081/files/...", // 静态文件下载链接
      "ownerId": 1,
      "createTime": "2025-12-30T10:00:00"
    },
    {
      "id": 2,
      "title": "会议纪要",
      "docType": 1,
      "content": "..."   // 二进制数据(前端通常忽略列表里的content)
    }
  ]
}
```

### 3.2 创建协同文档

- **URL**: `http://localhost:8080/doc/create`
- **Method**: `POST`
- **Header**: `Authorization: <Token>`

**请求参数:**

JSON

```
{
  "title": "新文档标题",
  "docType": 1
}
```

**响应示例:**

JSON

```
{
  "code": 200,
  "data": {
    "docId": 25
  }
}
```

### 3.3 删除文档 (包含物理删除)

- **URL**: `http://localhost:8080/doc/delete/{id}`
- **Method**: `DELETE`
- **Header**: `Authorization: <Token>`
- **说明**:
  - 若为静态文件 (Type 0)，会同时删除 Go 服务器磁盘上的文件和 MySQL 记录。
  - 若为协同文档 (Type 1)，仅删除 MySQL 记录。

**响应示例:**

JSON

```
{
  "code": 200,
  "msg": "删除成功",
  "data": null
}
```

------

## 4. 文件存储与协同 (Go: 8081)

### 4.1 上传静态文件 (Type 0)

- **URL**: `http://localhost:8081/upload`
- **Method**: `POST`
- **Header**: `Authorization: <Token>`
- **Content-Type**: `multipart/form-data`

**请求参数:**

- `file`: (二进制文件对象)

**响应示例:**

JSON

```
{
  "status": "success",
  "docId": 101, // 数据库生成的 ID
  "url": "http://localhost:8081/files/example.jpg",
  "title": "example.jpg"
}
```

### 4.2 保存版本快照 (Type 1)

- **URL**: `http://localhost:8081/api/version/save`
- **Method**: `POST`
- **Header**: `Content-Type: application/json`

**请求参数:**

JSON

```
{
  "docId": "200",     // 文档 ID (字符串)
  "userId": 1,        // 操作用户 ID (数字)
  "versionNum": 1735555   // 版本号 (建议用时间戳或递增数字)
}
```

**响应示例:**

JSON

```
{
  "msg": "版本保存成功",
  "status": "success" // 或 code 200
}
```

------

## 5. WebSocket 实时协同 (Go: 8081)

此接口用于 Yjs 协同编辑。

- **URL**: `ws://localhost:8081/ws/{roomId}`
- **Query Params**: `?token=<Token>`
- **示例**: `ws://localhost:8081/ws/200?token=eyJhbG...`

**连接流程:**

1. 前端建立连接。
2. Go 后端验证 Token (若失败直接断开)。
3. Go 后端从 Redis 读取历史数据并发送给前端。
4. 连接保持期间，每 30 秒 Go 后端自动将数据异步写入 MySQL 备份。

------

## 6. 信息查询 (补充接口)

### 6.1 获取当前用户信息

- **URL**: `http://localhost:8080/user/info`
- **Method**: `GET`
- **Header**: `Authorization: <Token>`
- **响应**:

JSON

```
{
  "code": 200,
  "data": {
    "id": 1,
    "username": "admin",
    "nickname": "管理员",
    "role": "ADMIN",
    "createTime": "..."
  }
}
```

### 6.2 获取用户列表

- **URL**: `http://localhost:8080/user/list`
- **Method**: `GET`
- **Header**: `Authorization: <Token>`
- **响应**: 返回用户数组 `[User, User, ...]`

### 6.3 获取文档详情

- **URL**: `http://localhost:8080/doc/detail/{id}`
- **Method**: `GET`
- **Header**: `Authorization: <Token>`
- **响应**:

JSON

```
{
  "code": 200,
  "data": {
    "id": 200,
    "title": "需求文档",
    "ownerId": 1,
    "version": 5,
    "updateTime": "..."
  }
}
```

### 6.4 获取文档版本历史

- **URL**: `http://localhost:8080/version/list/{docId}`
- **Method**: `GET`
- **Header**: `Authorization: <Token>`
- **响应**:

JSON

```
{
  "code": 200,
  "data": [
    {
      "id": 55,
      "docId": 200,
      "versionNum": 1735555,
      "createTime": "2025-12-30 12:00:00",
      "editorId": 1
    },
    ...
  ]
}
```



